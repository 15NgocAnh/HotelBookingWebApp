@page
@model HotelBooking.Web.Pages.Bookings.CreateModel
@{
    ViewData["Title"] = "Create Booking";
    Layout = "_Layout";
}

<div class="container-fluid px-4 py-5">
    <div class="card shadow-lg border-0 rounded-4" style="background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);">
        <div class="card-header bg-primary text-white py-4 rounded-top-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-calendar-plus fa-2x me-3"></i> 
                <div>
                    <h4 class="mb-1">Create New Booking</h4>
                    <p class="mb-0 text-white-50">Fill in the details below to create a new booking</p>
                </div>
            </div>
        </div>
        <div class="card-body p-4">
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center" role="alert" id="errorAlert">
                    <i class="fas fa-exclamation-circle me-2"></i> 
                    <div>@TempData["ErrorMessage"]</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show d-flex align-items-center" role="alert">
                    <i class="fas fa-check-circle me-2"></i> 
                    <div>@TempData["SuccessMessage"]</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <form method="post" id="bookingForm" class="needs-validation" novalidate>
                <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4" role="alert" aria-live="assertive"></div>

                <!-- Room Selection Section -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-light py-3">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-door-open me-2 text-primary"></i> 
                            Room Selection
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="RoomId" class="form-label fw-bold">Select Room</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-bed"></i> 
                                        </span>
                                        <select asp-for="Booking.RoomId" class="form-control" id="RoomId" aria-required="true">
                                            <option value="">-- Select Room --</option>
                                            @foreach (var category in Model.AvailableRooms)
                                            {
                                                <option value="@category.Id">@category.Name</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="form-text text-muted mt-1">Choose a room from our available options</div>
                                    <span asp-validation-for="Booking.RoomId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="CheckInDate" class="form-label fw-bold">Check-in Date</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-calendar-check"></i> 
                                        </span>
                                        <input asp-for="Booking.CheckInDate" class="form-control form-control-lg" type="date" id="CheckInDate" aria-required="true" />
                                    </div>
                                    <div class="form-text text-muted mt-1">Select your arrival date</div>
                                    <span asp-validation-for="Booking.CheckInDate" class="text-danger"></span>
                                </div>
                                <div class="form-group">
                                    <label for="CheckOutDate" class="form-label fw-bold">Check-out Date</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-calendar-times"></i> 
                                        </span>
                                        <input asp-for="Booking.CheckOutDate" class="form-control form-control-lg" type="date" id="CheckOutDate" aria-required="true" />
                                    </div>
                                    <div class="form-text text-muted mt-1">Select your departure date</div>
                                    <span asp-validation-for="Booking.CheckOutDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Guest Information Section -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-light py-3">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-users me-2 text-primary"></i> 
                            Guest Information
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div id="guestContainer" class="accordion" role="region" aria-label="Guest Information">
                            @if (Model.Booking.Guests != null && Model.Booking.Guests.Any())
                            {
                                @for (int i = 0; i < Model.Booking.Guests.Count; i++)
                                {
                                    <div class="guest-entry accordion-item mb-3 border rounded-3">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#guestCollapse_@i" aria-expanded="false" aria-controls="guestCollapse_@i">
                                                <i class="fas fa-user me-2"></i> Guest @(i + 1)
                                            </button>
                                        </h2>
                                        <div id="guestCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#guestContainer">
                                            <div class="accordion-body p-4">
                                                <input type="hidden" asp-for="Booking.Guests[i].Id" />
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="GuestFirstName_@i" class="form-label fw-bold">First Name</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light">
                                                                    <i class="fas fa-user"></i> 
                                                                </span>
                                                                <input asp-for="Booking.Guests[i].FirstName" class="form-control" id="GuestFirstName_@i" placeholder="Enter first name" required />
                                                            </div>
                                                            <span asp-validation-for="Booking.Guests[i].FirstName" class="text-danger"></span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="GuestLastName_@i" class="form-label fw-bold">Last Name</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light">
                                                                    <i class="fas fa-user"></i> 
                                                                </span>
                                                                <input asp-for="Booking.Guests[i].LastName" class="form-control" id="GuestLastName_@i" placeholder="Enter last name" required />
                                                            </div>
                                                            <span asp-validation-for="Booking.Guests[i].LastName" class="text-danger"></span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <label for="GuestPhoneNumber_@i" class="form-label fw-bold">Số điện thoại</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light">
                                                                    <i class="fas fa-phone"></i> 
                                                                </span>
                                                                <input asp-for="Booking.Guests[i].PhoneNumber" class="form-control" id="GuestPhoneNumber_@i" 
                                                                       placeholder="0123456789" 
                                                                       pattern="^(0[3|5|7|8|9])+([0-9]{8})$" />
                                                            </div>
                                                            <small id="phoneHelp_@i" class="form-text text-muted">Ví dụ: 0912345678</small>
                                                            <span asp-validation-for="Booking.Guests[i].PhoneNumber" class="text-danger"></span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <label for="GuestCitizenIdNumber_@i" class="form-label fw-bold">Số CMND/CCCD</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light">
                                                                    <i class="fas fa-id-card"></i> 
                                                                </span>
                                                                <input asp-for="Booking.Guests[i].CitizenIdNumber" class="form-control" id="GuestCitizenIdNumber_@i" 
                                                                       placeholder="001234567890" 
                                                                       pattern="^[0-9]{9}|[0-9]{12}$" />
                                                            </div>
                                                            <small id="citizenIdHelp_@i" class="form-text text-muted">9 số (CMND) hoặc 12 số (CCCD)</small>
                                                            <span asp-validation-for="Booking.Guests[i].CitizenIdNumber" class="text-danger"></span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <label for="GuestPassportNumber_@i" class="form-label fw-bold">Số hộ chiếu</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light">
                                                                    <i class="fas fa-passport"></i> 
                                                                </span>
                                                                <input asp-for="Booking.Guests[i].PassportNumber" class="form-control" id="GuestPassportNumber_@i" 
                                                                       placeholder="A12345678" 
                                                                       pattern="^[A-Z][0-9]{7}$" />
                                                            </div>
                                                            <small id="passportHelp_@i" class="form-text text-muted">Ví dụ: A12345678</small>
                                                            <span asp-validation-for="Booking.Guests[i].PassportNumber" class="text-danger"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-outline-danger btn-sm mt-3 remove-guest">
                                                    <i class="fas fa-trash-alt me-1"></i> Remove Guest
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                        <button type="button" class="btn btn-outline-primary mt-3" id="addGuest">
                            <i class="fas fa-user-plus me-1"></i> Add Guest
                        </button>
                    </div>
                </div>

                <!-- Extra Services Section -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-light py-3">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-concierge-bell me-2 text-primary"></i> 
                            Extra Services
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div id="extraUsageContainer" class="accordion" role="region" aria-label="Extra Services">
                            @if (Model.Booking.ExtraUsages != null && Model.Booking.ExtraUsages.Any())
                            {
                                @for (int i = 0; i < Model.Booking.ExtraUsages.Count; i++)
                                {
                                    <div class="extra-usage-entry accordion-item mb-3 border rounded-3">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#extraCollapse_@i" aria-expanded="false" aria-controls="extraCollapse_@i">
                                                <i class="fas fa-plus-circle me-2"></i> Extra Service @(i + 1)
                                            </button>
                                        </h2>
                                        <div id="extraCollapse_@i" class="accordion-collapse collapse" data-bs-parent="#extraUsageContainer">
                                            <div class="accordion-body p-4">
                                                <input type="hidden" asp-for="Booking.ExtraUsages[i].Id" />
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="ExtraItemId_@i" class="form-label fw-bold">Service</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light">
                                                                    <i class="fas fa-concierge-bell"></i> 
                                                                </span>
                                                                <select asp-for="Booking.ExtraUsages[i].ExtraItemId" class="form-select" asp-items="@(new SelectList(Model.AvailableExtraItems, "Id", "Name"))" id="ExtraItemId_@i" required>
                                                                    <option value="">-- Select Service --</option>
                                                                </select>
                                                            </div>
                                                            <span asp-validation-for="Booking.ExtraUsages[i].ExtraItemId" class="text-danger"></span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="Quantity_@i" class="form-label fw-bold">Quantity</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light">
                                                                    <i class="fas fa-sort-numeric-up"></i> 
                                                                </span>
                                                                <input asp-for="Booking.ExtraUsages[i].Quantity" class="form-control" type="number" min="1" id="Quantity_@i" required />
                                                            </div>
                                                            <span asp-validation-for="Booking.ExtraUsages[i].Quantity" class="text-danger"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-outline-danger btn-sm mt-3 remove-extra">
                                                    <i class="fas fa-trash-alt me-1"></i> Remove Service
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                        <button type="button" class="btn btn-outline-primary mt-3" id="addExtra">
                            <i class="fas fa-plus me-1"></i> Add Extra Service
                        </button>
                    </div>
                </div>

                <!-- Special Requests Section -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-light py-3">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-comment-alt me-2 text-primary"></i> 
                            Special Requests
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="form-group">
                            <label for="Notes" class="form-label fw-bold">Special Requests</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-comment"></i> 
                                </span>
                                <textarea asp-for="Booking.Notes" class="form-control" rows="4" id="Notes" placeholder="Enter any special requests or additional information"></textarea>
                            </div>
                            <div class="form-text text-muted mt-1">Let us know if you have any special requirements</div>
                            <span asp-validation-for="Booking.Notes" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-primary px-4 py-2" aria-label="Create Booking">
                        <i class="fas fa-save me-2"></i> Create Booking
                    </button>
                    <a asp-page="Index" class="btn btn-outline-secondary px-4 py-2" aria-label="Back to List">
                        <i class="fas fa-arrow-left me-2"></i> Back to List
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Date validation with improved UX
            const checkInDate = document.getElementById('CheckInDate');
            const checkOutDate = document.getElementById('CheckOutDate');
            const today = new Date().toISOString().split('T')[0];

            checkInDate.min = today;
            checkOutDate.min = today;

            checkInDate.addEventListener('change', function () {
                checkOutDate.min = this.value;
                if (checkOutDate.value && checkOutDate.value < this.value) {
                    checkOutDate.value = this.value;
                }
                updateDateValidation();
            });

            checkOutDate.addEventListener('change', updateDateValidation);

            function updateDateValidation() {
                const checkIn = new Date(checkInDate.value);
                const checkOut = new Date(checkOutDate.value);
                
                if (checkIn && checkOut) {
                    const diffTime = Math.abs(checkOut - checkIn);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 30) {
                        showToast('warning', 'Booking duration exceeds 30 days. Please contact support for longer stays.');
                    }
                }
            }

            // Guest management with improved UX
            let guestIndex = @(Model.Booking.Guests?.Count ?? 0);
            const guestContainer = document.getElementById('guestContainer');
            const addGuestBtn = document.getElementById('addGuest');

            addGuestBtn.addEventListener('click', function () {
                const guestHtml = `
                    <div class="guest-entry accordion-item mb-3 border rounded-3">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#guestCollapse_${guestIndex}" aria-expanded="false" aria-controls="guestCollapse_${guestIndex}">
                                <i class="fas fa-user me-2"></i> Guest ${guestIndex + 1}
                            </button>
                        </h2>
                        <div id="guestCollapse_${guestIndex}" class="accordion-collapse collapse" data-bs-parent="#guestContainer">
                            <div class="accordion-body p-4">
                                <input type="hidden" name="Booking.Guests[${guestIndex}].Id" value="0" />
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="GuestFirstName_${guestIndex}" class="form-label fw-bold">First Name</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-user"></i> 
                                                </span>
                                                <input name="Booking.Guests[${guestIndex}].FirstName" class="form-control" id="GuestFirstName_${guestIndex}" placeholder="Enter first name" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="GuestLastName_${guestIndex}" class="form-label fw-bold">Last Name</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-user"></i> 
                                                </span>
                                                <input name="Booking.Guests[${guestIndex}].LastName" class="form-control" id="GuestLastName_${guestIndex}" placeholder="Enter last name" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="GuestPhoneNumber_${guestIndex}" class="form-label fw-bold">Số điện thoại</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-phone"></i> 
                                                </span>
                                                <input name="Booking.Guests[${guestIndex}].PhoneNumber" class="form-control" id="GuestPhoneNumber_${guestIndex}" 
                                                       placeholder="0123456789" 
                                                       pattern="^(0[3|5|7|8|9])+([0-9]{8})$" />
                                            </div>
                                            <small id="phoneHelp_${guestIndex}" class="form-text text-muted">Ví dụ: 0912345678</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="GuestCitizenIdNumber_${guestIndex}" class="form-label fw-bold">Số CMND/CCCD</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-id-card"></i> 
                                                </span>
                                                <input name="Booking.Guests[${guestIndex}].CitizenIdNumber" class="form-control" id="GuestCitizenIdNumber_${guestIndex}" 
                                                       placeholder="001234567890" 
                                                       pattern="^[0-9]{9}|[0-9]{12}$" />
                                            </div>
                                            <small id="citizenIdHelp_${guestIndex}" class="form-text text-muted">9 số (CMND) hoặc 12 số (CCCD)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="GuestPassportNumber_${guestIndex}" class="form-label fw-bold">Số hộ chiếu</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-passport"></i> 
                                                </span>
                                                <input name="Booking.Guests[${guestIndex}].PassportNumber" class="form-control" id="GuestPassportNumber_${guestIndex}" 
                                                       placeholder="A12345678" 
                                                       pattern="^[A-Z][0-9]{7}$" />
                                            </div>
                                            <small id="passportHelp_${guestIndex}" class="form-text text-muted">Ví dụ: A12345678</small>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm mt-3 remove-guest">
                                    <i class="fas fa-trash-alt me-1"></i> Remove Guest
                                </button>
                            </div>
                        </div>
                    </div>`;
                guestContainer.insertAdjacentHTML('beforeend', guestHtml);
                guestIndex++;
                
                // Auto-expand the newly added guest section
                const newGuestSection = document.getElementById(`guestCollapse_${guestIndex - 1}`);
                const bsCollapse = new bootstrap.Collapse(newGuestSection, { toggle: true });
            });

            guestContainer.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-guest')) {
                    const guestEntry = e.target.closest('.guest-entry');
                    if (confirm('Bạn có chắc chắn muốn xóa khách này?')) {
                        guestEntry.remove();
                        // Reindex remaining guests
                        const remainingGuests = document.querySelectorAll('.guest-entry');
                        remainingGuests.forEach((entry, index) => {
                            const inputs = entry.querySelectorAll('input[name^="Booking.Guests"]');
                            inputs.forEach(input => {
                                const newName = input.name.replace(/\[\d+\]/, `[${index}]`);
                                input.name = newName;
                            });
                        });
                    }
                }
            });

            // Real-time validation for guest information
            guestContainer.addEventListener('input', function (e) {
                if (e.target.matches('[id^="GuestPhoneNumber_"]')) {
                    const phoneInput = e.target;
                    const phonePattern = /^(0[3|5|7|8|9])+([0-9]{8})$/;
                    const helpText = phoneInput.nextElementSibling.nextElementSibling;
                    
                    if (!phonePattern.test(phoneInput.value) && phoneInput.value !== '') {
                        phoneInput.classList.add('is-invalid');
                        helpText.textContent = 'Vui lòng nhập số điện thoại hợp lệ (VD: 0912345678)';
                        helpText.classList.add('text-danger');
                    } else {
                        phoneInput.classList.remove('is-invalid');
                        helpText.textContent = 'Ví dụ: 0912345678';
                        helpText.classList.remove('text-danger');
                    }
                }
                else if (e.target.matches('[id^="GuestCitizenIdNumber_"]')) {
                    const citizenIdInput = e.target;
                    const citizenIdPattern = /^[0-9]{9}|[0-9]{12}$/;
                    const helpText = citizenIdInput.nextElementSibling.nextElementSibling;
                    
                    if (!citizenIdPattern.test(citizenIdInput.value) && citizenIdInput.value !== '') {
                        citizenIdInput.classList.add('is-invalid');
                        helpText.textContent = 'Vui lòng nhập CMND (9 số) hoặc CCCD (12 số)';
                        helpText.classList.add('text-danger');
                    } else {
                        citizenIdInput.classList.remove('is-invalid');
                        helpText.textContent = '9 số (CMND) hoặc 12 số (CCCD)';
                        helpText.classList.remove('text-danger');
                    }
                }
                else if (e.target.matches('[id^="GuestPassportNumber_"]')) {
                    const passportInput = e.target;
                    const passportPattern = /^[A-Z][0-9]{7}$/;
                    const helpText = passportInput.nextElementSibling.nextElementSibling;
                    
                    if (!passportPattern.test(passportInput.value) && passportInput.value !== '') {
                        passportInput.classList.add('is-invalid');
                        helpText.textContent = 'Vui lòng nhập số hộ chiếu hợp lệ (VD: A12345678)';
                        helpText.classList.add('text-danger');
                    } else {
                        passportInput.classList.remove('is-invalid');
                        helpText.textContent = 'Ví dụ: A12345678';
                        helpText.classList.remove('text-danger');
                    }
                }
            });

            // Extra Usage management with improved UX
            let extraIndex = @(Model.Booking.ExtraUsages?.Count ?? 0);
            const extraContainer = document.getElementById('extraUsageContainer');
            const addExtraBtn = document.getElementById('addExtra');

            addExtraBtn.addEventListener('click', function () {
                const extraHtml = `
                    <div class="extra-usage-entry accordion-item mb-3 border rounded-3">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#extraCollapse_${extraIndex}" aria-expanded="false" aria-controls="extraCollapse_${extraIndex}">
                                <i class="fas fa-plus-circle me-2"></i> Extra Service ${extraIndex + 1}
                            </button>
                        </h2>
                        <div id="extraCollapse_${extraIndex}" class="accordion-collapse collapse" data-bs-parent="#extraUsageContainer">
                            <div class="accordion-body p-4">
                                <input type="hidden" name="Booking.ExtraUsages[${extraIndex}].Id" value="0" />
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="ExtraItemId_${extraIndex}" class="form-label fw-bold">Service</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-concierge-bell"></i> 
                                                </span>
                                                <select name="Booking.ExtraUsages[${extraIndex}].ExtraItemId" class="form-select" id="ExtraItemId_${extraIndex}" required>
                                                    <option value="">-- Select Service --</option>
                                                    @foreach (var item in Model.AvailableExtraItems)
                                                    {
                                                        <option value="@item.Id">@item.Name</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="Quantity_${extraIndex}" class="form-label fw-bold">Quantity</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-sort-numeric-up"></i> 
                                                </span>
                                                <input name="Booking.ExtraUsages[${extraIndex}].Quantity" class="form-control" type="number" min="1" id="Quantity_${extraIndex}" required />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm mt-3 remove-extra">
                                    <i class="fas fa-trash-alt me-1"></i> Remove Service
                                </button>
                            </div>
                        </div>
                    </div>`;
                extraContainer.insertAdjacentHTML('beforeend', extraHtml);
                extraIndex++;
                
                // Auto-expand the newly added extra service section
                const newExtraSection = document.getElementById(`extraCollapse_${extraIndex - 1}`);
                const bsCollapse = new bootstrap.Collapse(newExtraSection, { toggle: true });
            });

            extraContainer.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-extra')) {
                    const extraEntry = e.target.closest('.extra-usage-entry');
                    if (confirm('Are you sure you want to remove this service?')) {
                        extraEntry.remove();
                    }
                }
            });

            // Form validation and submission handling
            const form = document.getElementById('bookingForm');
            form.addEventListener('submit', function (e) {
                e.preventDefault(); // Prevent default form submission

                // Reindex guest entries
                const guestEntries = document.querySelectorAll('.guest-entry');
                guestEntries.forEach((entry, index) => {
                    const inputs = entry.querySelectorAll('input[name^="Booking.Guests"]');
                    inputs.forEach(input => {
                        const newName = input.name.replace(/\[\d+\]/, `[${index}]`);
                        input.name = newName;
                    });
                });

                // Show loading state
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Đang xử lý...';

                // Submit form
                form.submit();
            });

            // Toast notification function
            function showToast(type, message) {
                const toastContainer = document.createElement('div');
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '5';
                
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i> 
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>`;
                
                toastContainer.appendChild(toast);
                document.body.appendChild(toastContainer);
                
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                
                toast.addEventListener('hidden.bs.toast', function () {
                    toastContainer.remove();
                });
            }

            // Auto-save functionality
            let autoSaveTimeout;
            const formInputs = form.querySelectorAll('input, select, textarea');
            
            formInputs.forEach(input => {
                input.addEventListener('change', function() {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        const formData = new FormData(form);
                        localStorage.setItem('bookingFormData', JSON.stringify(Object.fromEntries(formData)));
                        showToast('success', 'Form data auto-saved');
                    }, 1000);
                });
            });

            // Load auto-saved data if exists
            const savedData = localStorage.getItem('bookingFormData');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.keys(data).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = data[key];
                    }
                });
            }
        });
    </script>
}